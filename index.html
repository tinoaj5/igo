<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DogWalkr ‚Äî Switzerland</title>
  <meta name="description" content="Book trusted dog walkers in Switzerland with saved profiles and Swiss address validation." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üêæ</text></svg>">
  <style>
    :root{ --bg:#0b0f14; --card:#0f1722cc; --text:#e8f0ff; --text-dim:#b7c2d6; --brand:#7cc6ff; --shadow:0 10px 30px rgba(0,0,0,.35); --ring:0 0 0 2px rgba(124,198,255,.35); --radius:18px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font:16px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text);
         background:radial-gradient(1200px 600px at 10% 10%, #162030, transparent 50%), radial-gradient(800px 600px at 100% 0%, #1a2740, transparent 40%), var(--bg);}
    a{color:var(--brand); text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:1100px; margin:0 auto; padding:28px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:6px 12px; background:linear-gradient(180deg,rgba(255,255,255,.03),transparent); border-radius:var(--radius)}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px}
    .logo{width:36px; height:36px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg, #7cc6ff 0%, #b7ffcc 100%); box-shadow:var(--shadow); color:#001428; font-size:20px}
    nav{display:flex; gap:14px; align-items:center}
    .btn{appearance:none; border:0; background:linear-gradient(180deg, #122033, #0f1826); color:var(--text); padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:700; box-shadow:var(--shadow); transition: transform .05s ease, box-shadow .2s ease, filter .2s ease; font-size:14px;}
    .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)} .btn.primary{background:linear-gradient(180deg, #80d0ff, #66a8ff); color:#021326} .btn.ghost{background:transparent; border:1px solid #233145}
    .hero{display:grid; grid-template-columns: 1.2fr 1fr; gap:28px; margin:44px 0 28px} .card{background:var(--card); border:1px solid #213149; border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(8px)} .hero .card{padding:32px}
    .eyebrow{display:inline-flex; align-items:center; gap:10px; font-size:12px; color:var(--text-dim); background:#0b1320; border:1px solid #1e2b40; padding:6px 10px; border-radius:999px}
    h1{margin:12px 0 6px; font-size:44px; line-height:1.1; letter-spacing:-.02em} .lead{color:var(--text-dim); margin:8px 0 20px} .cta{display:flex; gap:12px; flex-wrap:wrap}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid #1f2c43; border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:18px} .section{margin:38px 0} .section h2{margin:0 0 12px; font-size:22px}
    .muted{color:var(--text-dim)} .list{display:grid; gap:8px; margin:8px 0 0; padding:0; list-style:none} .list li{display:flex; gap:10px; align-items:flex-start} .pill{display:inline-flex; align-items:center; gap:8px; border:1px solid #213149; background:#0d1522; padding:6px 10px; border-radius:999px; font-size:12px; color:#c2d2ec}
    footer{margin:42px 0 8px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; color:var(--text-dim)} footer .links{display:flex; gap:16px; align-items:center}
    dialog{width:min(560px, 92vw); border:1px solid #253552; background:#0c1320; border-radius:18px; color:#e9f2ff; box-shadow: var(--shadow)} dialog::backdrop{background:rgba(1,5,12,.6); backdrop-filter: blur(3px)}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #1d2a41} .modal-body{padding:16px}
    form{display:grid; gap:12px} label{font-size:13px; color:#c7d4ea} input,select,textarea{width:100%; padding:12px; border-radius:12px; background:#0a111c; color:#e9f2ff; border:1px solid #20304a; outline:none; transition: box-shadow .15s ease, border-color .15s ease}
    input:focus, select:focus, textarea:focus{box-shadow: var(--ring); border-color:#3a5a86} textarea{min-height:92px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px} .terms{display:flex; gap:10px; align-items:flex-start; font-size:13px; color:#c9d7ee}
    .toast{position:fixed; top:18px; right:18px; background:linear-gradient(180deg,#122033,#0f1826); border:1px solid #22324c; color:#e9f2ff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); display:none}
    .hint{font-size:12px; color:#b7c2d6}
    .chip{display:inline-flex; align-items:center; gap:8px; border:1px solid #213149; background:#0d1522; padding:6px 10px; border-radius:999px; font-size:12px; color:#c2d2ec}
    .inline{display:inline-flex; gap:8px; align-items:center}
    .field-rel{position:relative}
    .suggest-list{position:absolute;left:0;right:0;top:100%;margin-top:6px;z-index:99999;background:#0c1320;border:1px solid #253552;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.35);max-height:260px;overflow:auto;display:none}
    .suggest-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.06)}
    .suggest-item:last-child{border-bottom:0}.suggest-item:hover,.suggest-item.active{background:rgba(255,255,255,.08)}
    .suggest-item .secondary{font-size:12px; opacity:.8}
    @media (max-width: 900px){ .hero{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div class="brand">
        <div class="logo">üêæ</div>
        <div>
          <div style="font-size:14px; color:var(--text-dim); line-height:1;">Introducing</div>
          <div style="font-size:18px;">DogWalkr ‚Äî Switzerland</div>
        </div>
      </div>
      <nav>
        <a href="#how">How it works</a>
        <a href="#faq">FAQ</a>
        <button class="btn ghost" onclick="openWalker()">Become a Walker</button>
        <button class="btn primary" onclick="openOwner()">Book a Walk</button>
        <button class="btn" id="signinBtn" onclick="openSignin()">Sign in</button>
        <div id="userChip" style="display:none" class="chip"></div>
      </nav>
    </header>

    <section class="hero">
      <div class="card">
        <span class="eyebrow">Simple ‚Ä¢ Safe ‚Ä¢ Accounts</span>
        <h1>Book trusted dog walkers <span style="color:var(--brand)">in minutes</span>.</h1>
        <p class="lead">Create an account once, and your info auto-fills every time ‚Äî for owners and walkers.</p>
        <div class="cta">
          <button class="btn primary" onclick="openOwner()">Book a Walk</button>
          <button class="btn" onclick="openWalker()">Become a Walker</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:16px; flex-wrap:wrap">
          <span class="pill">‚è±Ô∏è 30‚Äì90 min walks</span>
          <span class="pill">üìç Z√ºrich ‚Ä¢ Gen√®ve ‚Ä¢ Basel ‚Ä¢ Bern</span>
          <span class="pill">üí¨ Photo updates</span>
          <span class="pill">‚≠ê Two-way ratings</span>
        </div>
      </div>
      <div class="glass">
        <div class="section">
          <h2>Why DogWalkr?</h2>
        </div>
        <div class="grid">
          <div class="glass"><div class="caps">Owners</div><div class="muted small">Pick date/time & duration. Add dog details and notes.</div></div>
          <div class="glass"><div class="caps">Walkers</div><div class="muted small">Browse nearby jobs. Accept. Complete walk. Get paid.</div></div>
          <div class="glass"><div class="caps">Platform</div><div class="muted small">Small fee per walk. Trust tools. Later: payments & insurance.</div></div>
        </div>
      </div>
    </section>

    <section class="section" id="faq">
      <h2>FAQ</h2>
      <div class="glass">
        <details>
          <summary><b>Do I need an account?</b></summary>
          <p class="muted small">No, but if you sign in and complete your profile, we‚Äôll auto-fill your forms next time.</p>
        </details>
        <details>
          <summary><b>Why is the code email slow?</b></summary>
          <p class="muted small">Google Apps Script can take 30‚Äì120 seconds to send on the first run (cold start). You can press ‚ÄúResend code‚Äù after a short timer.</p>
        </details>
      </div>
    </section>

    <footer>
      <div class="links inline">
        <a href="terms.html">Terms</a>
        <span>‚Ä¢</span>
        <a href="privacy.html">Privacy</a>
      </div>
      <div class="small">¬© <span id="yr"></span> DogWalkr. Made with ‚ù§Ô∏è</div>
    </footer>
  </div>

  <!-- Sign-in Modal -->
  <dialog id="signinModal">
    <div class="modal-head">
      <strong>Sign in / Create account</strong>
      <button class="btn ghost small" onclick="closeSignin()">Close</button>
    </div>
    <div class="modal-body">
      <form id="signinForm">
        <label>Email (we‚Äôll send a 6-digit code)</label>
        <input required type="email" name="email" placeholder="you@email.com">
        <div class="inline">
          <button class="btn primary" type="submit">Send code</button>
          <button class="btn" id="resendBtn" type="button" disabled>Resend code (<span id="resendT">30</span>s)</button>
        </div>
        <div class="hint">Check Spam/Promotions too. It can take 30‚Äì120s on the first try.</div>
      </form>
      <form id="codeForm" style="display:none">
        <label>Enter 6-digit code</label>
        <input required inputmode="numeric" pattern="\\d{6}" minlength="6" maxlength="6" name="code" placeholder="123456">
        <button class="btn primary" type="submit">Verify</button>
      </form>
    </div>
  </dialog>

  <!-- Profile Modal -->
  <dialog id="profileModal">
    <div class="modal-head">
      <strong>Complete your profile</strong>
      <button class="btn ghost small" onclick="closeProfile()">Close</button>
    </div>
    <div class="modal-body">
      <form id="profileForm">
        <div class="row">
          <div><label>Full name</label><input name="name" placeholder="Jane Doe" required></div>
          <div><label>Email</label><input name="email" type="email" placeholder="you@email.com" required></div>
        </div>
        <div class="row">
          <div><label>Phone</label><input name="phone" placeholder="+41 79 123 45 67" required></div>
          <div class="field-rel">
            <label>Address</label>
            <input name="address" id="address_profile" placeholder="Bahnhofstrasse 1, Z√ºrich" autocomplete="off" required>
            <div id="profile_suggest" class="suggest-list" style="display:none;"></div>
            <input type="hidden" name="place_id" id="p_place_id">
            <input type="hidden" name="lat" id="p_lat">
            <input type="hidden" name="lng" id="p_lng">
            <input type="hidden" name="formatted_address" id="p_formatted_address">
            <input type="hidden" name="postal_code" id="p_postal_code">
            <input type="hidden" name="locality" id="p_locality">
            <input type="hidden" name="canton" id="p_canton">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Role (optional)</label>
            <select name="role"><option value="">‚Äî</option><option value="owner">Owner</option><option value="walker">Walker</option></select>
          </div>
          <div>
            <label>Preferred pay method</label>
            <select name="pay_method"><option>Cash</option><option>Transfer</option></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Walker experience (if applicable)</label>
            <select name="experience"><option value="">‚Äî</option><option>Beginner</option><option>Intermediate</option><option>Pro</option></select>
          </div>
          <div><label>Rate per hour (CHF)</label><input name="rate" type="number" min="1" step="1" placeholder="25"></div>
        </div>
        <label>About you (optional)</label>
        <textarea name="bio" placeholder="Short intro: experience with breeds, training, etc."></textarea>
        <div class="row">
          <div><button class="btn primary" type="submit">Save profile</button></div>
          <div><button class="btn" type="button" onclick="addCard()">Add card (Stripe)</button></div>
        </div>
        <p class="muted small">We never store card numbers. ‚ÄúAdd card‚Äù uses Stripe (later) to save a payment method safely.</p>
      </form>
    </div>
  </dialog>

  <!-- Owner Modal -->
  <dialog id="ownerModal">
    <div class="modal-head">
      <strong>Book a Walk</strong>
      <button class="btn ghost small" onclick="closeOwner()">Close</button>
    </div>
    <div class="modal-body">
      <form id="ownerForm">
        <div class="row">
          <div><label>Full name</label><input required name="name" placeholder="Jane Doe"></div>
          <div><label>Email</label><input required type="email" name="email" placeholder="jane@email.com"></div>
        </div>
        <div class="row">
          <div><label>Phone</label><input required name="phone" placeholder="+41 79 123 45 67"></div>
          <div class="field-rel">
            <label>Neighborhood / Address</label>
            <input required name="address" id="address_owner" placeholder="Bahnhofstrasse 1, Z√ºrich" autocomplete="off">
            <div id="owner_suggest" class="suggest-list" style="display:none;"></div>
            <input type="hidden" name="place_id" id="o_place_id">
            <input type="hidden" name="lat" id="o_lat">
            <input type="hidden" name="lng" id="o_lng">
            <input type="hidden" name="formatted_address" id="o_formatted_address">
            <input type="hidden" name="postal_code" id="o_postal_code">
            <input type="hidden" name="locality" id="o_locality">
            <input type="hidden" name="canton" id="o_canton">
          </div>
        </div>
        <div class="row">
          <div><label>Dog name</label><input required name="dog_name" placeholder="Biscuit"></div>
          <div>
            <label>Dog size</label>
            <select name="dog_size" required><option value="">Choose‚Ä¶</option><option>Small</option><option>Medium</option><option>Large</option></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Temperament</label>
            <select name="temperament" required><option value="">Choose‚Ä¶</option><option>Calm</option><option>Energetic</option><option>Shy</option><option>Reactive</option></select>
          </div>
          <div><label>Special notes</label><input name="notes" placeholder="Leash reactive, avoid other dogs‚Ä¶"></div>
        </div>
        <div class="row">
          <div><label>Date</label><input required type="date" id="date_owner" name="date"></div>
          <div><label>Time</label><input required type="time" id="time_owner" name="time"></div>
        </div>
        <div class="row">
          <div>
            <label>Duration</label>
            <select name="duration" required><option value="">Choose‚Ä¶</option><option>30 min</option><option>45 min</option><option>60 min</option><option>90 min</option></select>
          </div>
          <div>
            <label>Preferred pay method</label>
            <select name="pay_method"><option>Cash</option><option>Transfer</option></select>
          </div>
        </div>
        <label>Extra details</label>
        <textarea name="extra" placeholder="Any building entry notes, route preference, etc."></textarea>
        <div class="terms"><input required type="checkbox" id="ownerAgree"><label for="ownerAgree">I agree to the Terms and acknowledge the liability waiver.</label></div>
        <button class="btn primary" type="submit">Submit request</button>
      </form>
    </div>
  </dialog>

  <!-- Walker Modal -->
  <dialog id="walkerModal">
    <div class="modal-head">
      <strong>Become a Walker</strong>
      <button class="btn ghost small" onclick="closeWalker()">Close</button>
    </div>
    <div class="modal-body">
      <form id="walkerForm">
        <div class="row">
          <div><label>Full name</label><input required name="name" placeholder="John Smith"></div>
          <div><label>Email</label><input required type="email" name="email" placeholder="john@email.com"></div>
        </div>
        <div class="row">
          <div><label>Phone</label><input required name="phone" placeholder="+41 78 123 45 67"></div>
          <div><label>City</label><input required name="city" placeholder="Z√ºrich / Gen√®ve / Basel / Bern"></div>
        </div>
        <div class="row">
          <div>
            <label>Experience level</label>
            <select name="experience" required><option value="">Choose‚Ä¶</option><option>Beginner</option><option>Intermediate</option><option>Pro</option></select>
          </div>
          <div>
            <label>Background check badge</label>
            <select name="bg_check"><option>Not yet</option><option>Yes, verified</option></select>
          </div>
        </div>
        <div class="row">
          <div><label>Availability</label><input name="availability" placeholder="Weekdays 17:00‚Äì20:00; Weekends"></div>
          <div><label>Rate expectation (per hour)</label><input name="rate" type="number" min="1" step="1" placeholder="25"></div>
        </div>
        <label>About you</label>
        <textarea name="bio" placeholder="Short intro: experience with breeds, training, etc."></textarea>
        <div class="terms"><input required type="checkbox" id="walkerAgree"><label for="walkerAgree">I accept the Independent Contractor Terms and agree to follow safety guidelines.</label></div>
        <button class="btn primary" type="submit">Apply</button>
      </form>
    </div>
  </dialog>

  <div id="toast" class="toast">Saved. We‚Äôll get back to you soon.</div>

  <script>
    // === CONFIG ===
    window.FORM_ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbx3UWliJD5I0bLPuGX_fpoTjDm7SvOF3uLf-zVjgLpyS1u6KxhfK0BPoqm5DJMuLR3INQ/exec"; // Apps Script endpoint
    const AUTH_TOKEN_KEY = "dogwalkr_auth_token";
    const PROFILE_KEY = "dogwalkr_profile";

    // === UI refs ===
    const ownerModal = document.getElementById('ownerModal');
    const walkerModal = document.getElementById('walkerModal');
    const signinModal = document.getElementById('signinModal');
    const profileModal = document.getElementById('profileModal');
    const toast = document.getElementById('toast');
    const signinBtn = document.getElementById('signinBtn');
    const userChip = document.getElementById('userChip');
    const resendBtn = document.getElementById('resendBtn');
    const resendT = document.getElementById('resendT');

    function showToast(msg="Saved. We‚Äôll get back to you soon."){
      toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 2200);
    }

    async function postForm(obj){
      try {
        const r = await fetch(window.FORM_ENDPOINT_URL, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ payload: JSON.stringify(obj) })
        });
        const txt = await r.text().catch(()=>'');
        try { return JSON.parse(txt); } catch (_){
          return r.ok ? {ok:true, opaque:true} : {ok:false, error:'HTTP '+r.status};
        }
      } catch (e){
        try {
          await fetch(window.FORM_ENDPOINT_URL, {
            method:'POST', mode:'no-cors',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({ payload: JSON.stringify(obj) })
          });
          return {ok:true, opaque:true};
        } catch (err){
          return {ok:false, error:String(err)};
        }
      }
    }

    function renderAuthUI(){
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      const prof = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
      if(token){
        signinBtn.style.display='none';
        userChip.style.display='inline-flex';
        userChip.innerHTML = `${prof.name ? prof.name : (prof.email||'Account')} <button class="btn ghost small" style="margin-left:8px" onclick="openProfile()">Profile</button> <button class="btn ghost small" style="margin-left:8px" onclick="signOut()">Sign out</button>`;
      } else {
        signinBtn.style.display='inline-block';
        userChip.style.display='none';
      }
    }
    function signOut(){ localStorage.removeItem(AUTH_TOKEN_KEY); localStorage.removeItem(PROFILE_KEY); renderAuthUI(); showToast('Signed out'); }

    function prefillFormFromProfile(kind, preserveTime=false){
      try{
        const prof = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
        const form = (kind==='owner') ? document.getElementById('ownerForm') : document.getElementById('walkerForm');
        if(!form) return;
        const map = (k) => form.querySelector(`[name="${k}"]`);
        if (map('name') && prof.name) map('name').value = prof.name;
        if (map('email') && prof.email) map('email').value = prof.email;
        if (map('phone') && prof.phone) map('phone').value = prof.phone;
        if(kind==='owner'){
          if (map('address') && prof.formatted_address) map('address').value = prof.formatted_address;
          [['o_place_id','place_id'],['o_lat','lat'],['o_lng','lng'],['o_formatted_address','formatted_address'],['o_postal_code','postal_code'],['o_locality','locality'],['o_canton','canton']]
            .forEach(([id,key])=>{ const el = document.getElementById(id); if(el) el.value = prof[key] || ''; });
          if(!preserveTime){ /* leave date/time/duration empty intentionally */ }
        }
        if(kind==='walker'){
          if (map('city') && prof.locality) map('city').value = prof.locality;
          if (map('experience') && prof.experience) map('experience').value = prof.experience;
          if (map('bg_check') && prof.bg_check) map('bg_check').value = prof.bg_check;
          if (map('availability') && prof.availability) map('availability').value = prof.availability;
          if (map('rate') && prof.rate) map('rate').value = prof.rate;
          if (map('bio') && prof.bio) map('bio').value = prof.bio;
        }
      }catch(_){}
    }

    function prefillProfileForm(){
      try{
        const prof = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
        const form = document.getElementById('profileForm');
        const map = (k) => form.querySelector(`[name="${k}"]`);
        ['name','email','phone','role','pay_method','experience','rate','bio'].forEach(k=>{ if(map(k) && prof[k]) map(k).value = prof[k]; });
        if (map('address') && prof.formatted_address) map('address').value = prof.formatted_address;
        [['p_place_id','place_id'],['p_lat','lat'],['p_lng','lng'],['p_formatted_address','formatted_address'],['p_postal_code','postal_code'],['p_locality','locality'],['p_canton','canton']]
          .forEach(([id,key])=>{ const el = document.getElementById(id); if(el && prof[key]) el.value = prof[key]; });
      }catch(_){}
    }

    async function getProfile(){
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if(!token) return null;
      const res = await postForm({ action:'get_profile', token });
      if(res && res.ok){ localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile || {})); return res.profile || null; }
      return null;
    }
    async function saveProfile(role, data){
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if(!token) return {ok:false};
      const res = await postForm({ action:'save_profile', token, role, profile: data });
      if(res && res.ok) localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile || {}));
      return res;
    }

    // === Places dropdown component (cities + addresses, CH-only) ===
    (function(){
      function makePlacesDropdown(cfg){
        var input = document.getElementById(cfg.inputId);
        var list  = document.getElementById(cfg.listId);
        if (!input || !list) { console.warn('[Places] missing input/list', cfg); return; }

        var acSvc = new google.maps.places.AutocompleteService();
        var ps    = new google.maps.places.PlacesService(document.createElement('div'));

        var items = [], active = -1, tId = null;

        function clear(){
          list.innerHTML = '';
          list.style.display = 'none';
          active = -1; items = [];
        }
        function setHidden(id, val){
          var el = document.getElementById(id);
          if (el) el.value = (val == null ? '' : val);
        }
        function choose(i){
          var pred = items[i]; if (!pred) return;
          ps.getDetails({ placeId: pred.place_id, fields: ['place_id','formatted_address','geometry','address_components','name'] },
            function(place, status){
              if (status !== google.maps.places.PlacesServiceStatus.OK || !place || !place.geometry) { clear(); return; }
              input.value = place.formatted_address || place.name || input.value;
              var comps = {};
              (place.address_components||[]).forEach(function(c){ (c.types||[]).forEach(function(t){ comps[t] = c.long_name; }); });
              setHidden(cfg.hidden.place_id, place.place_id || '');
              setHidden(cfg.hidden.lat, place.geometry.location.lat());
              setHidden(cfg.hidden.lng, place.geometry.location.lng());
              setHidden(cfg.hidden.formatted, place.formatted_address || place.name || input.value);
              setHidden(cfg.hidden.postal, comps.postal_code || '');
              setHidden(cfg.hidden.locality, comps.locality || comps.postal_town || comps.sublocality || '');
              setHidden(cfg.hidden.canton, comps.administrative_area_level_1 || '');
              clear();
            });
        }
        function render(preds){
          items = preds.slice(0, 8);
          list.innerHTML = items.map(function(p, i){
            var main = (p.structured_formatting && p.structured_formatting.main_text) || p.description;
            var sec  = (p.structured_formatting && p.structured_formatting.secondary_text) || '';
            return '<div class="suggest-item'+(i===active?' active':'')+'" data-i="'+i+'">'+
                   main + (sec ? '<div class="secondary">'+sec+'</div>' : '') + '</div>';
          }).join('');
          list.style.display = items.length ? 'block' : 'none';
          Array.prototype.forEach.call(list.children, function(el){
            el.addEventListener('click', function(){ choose(+el.dataset.i); });
          });
        }

        input.addEventListener('input', function(){
          // clear hidden fields while typing
          Object.keys(cfg.hidden).forEach(function(k){ setHidden(cfg.hidden[k], ''); });

          var q = input.value.trim();
          if (q.length < 2) { clear(); return; }
          clearTimeout(tId);
          tId = setTimeout(function(){
            acSvc.getPlacePredictions(
              { input: q, componentRestrictions: { country: ['ch'] } },
              function(preds, status){
                if (status !== google.maps.places.PlacesServiceStatus.OK || !preds || !preds.length) { clear(); return; }
                render(preds);
              }
            );
          }, 150);
        });

        input.addEventListener('keydown', function(e){
          if (!items.length || list.style.display === 'none') return;
          if (e.key === 'ArrowDown') { active = Math.min(active+1, items.length-1); render(items); e.preventDefault(); }
          else if (e.key === 'ArrowUp') { active = Math.max(active-1, 0); render(items); e.preventDefault(); }
          else if (e.key === 'Enter') { if (active > -1) { choose(active); e.preventDefault(); } }
          else if (e.key === 'Escape') { clear(); }
        });

        document.addEventListener('click', function(e){
          if (e.target !== input && !list.contains(e.target)) clear();
        });
      }

      function initPlacesDropdowns(){
        if (!window.google || !google.maps || !google.maps.places) {
          console.error('[Places] Maps JS not ready'); return;
        }
        makePlacesDropdown({
          inputId: 'address_owner',
          listId: 'owner_suggest',
          hidden: {
            place_id:'o_place_id', lat:'o_lat', lng:'o_lng',
            formatted:'o_formatted_address', postal:'o_postal_code',
            locality:'o_locality', canton:'o_canton'
          }
        });
        makePlacesDropdown({
          inputId: 'address_profile',
          listId: 'profile_suggest',
          hidden: {
            place_id:'p_place_id', lat:'p_lat', lng:'p_lng',
            formatted:'p_formatted_address', postal:'p_postal_code',
            locality:'p_locality', canton:'p_canton'
          }
        });
        console.log('[Places] Dropdowns attached');
      }

      if (typeof window.initMaps === 'function') {
        var prev = window.initMaps;
        window.initMaps = function(){ try{ prev(); }catch(e){ console.warn(e); } initPlacesDropdowns(); };
      } else {
        window.initMaps = initPlacesDropdowns;
      }
    })();

    // --- Modal open/close (robust) + date rule
    (function(){
      function supportsDialog(){
        try { return typeof HTMLDialogElement === 'function' && !!document.createElement('dialog').showModal; }
        catch (_){ return false; }
      }
      function openDlg(id){
        var dlg = document.getElementById(id);
        if(!dlg) return;
        try {
          if (supportsDialog()) dlg.showModal();
          else { dlg.setAttribute('open',''); dlg.style.display='block'; }
        } catch (err) {
          dlg.setAttribute('open',''); dlg.style.display='block';
        }
      }
      function closeDlg(id){
        var dlg = document.getElementById(id);
        if(!dlg) return;
        try {
          if (supportsDialog()) dlg.close();
          else { dlg.removeAttribute('open'); dlg.style.display='none'; }
        } catch (_){}
      }
      window.openOwner = function(){
        openDlg('ownerModal');
        try { prefillFormFromProfile('owner', true); } catch(_){}
        setDateMinToday();
      };
      window.closeOwner  = function(){ closeDlg('ownerModal'); };
      window.openWalker  = function(){
        openDlg('walkerModal');
        try { prefillFormFromProfile('walker'); } catch(_){}
      };
      window.closeWalker = function(){ closeDlg('walkerModal'); };
      window.openSignin  = function(){ openDlg('signinModal'); };
      window.closeSignin = function(){ closeDlg('signinModal'); };
    })();

    function setDateMinToday(){
      const el = document.getElementById('date_owner');
      if(!el) return;
      const tzToday = new Date().toISOString().slice(0,10);
      el.min = tzToday;
      if(!el.value) el.value = tzToday;
    }

    // --- Sign in / Verify
    let currentEmail = '';
    let timerId = null;
    function startResendTimer(seconds=30){
      clearInterval(timerId);
      resendBtn.disabled = true;
      resendT.textContent = String(seconds);
      timerId = setInterval(()=>{
        let v = parseInt(resendT.textContent,10); v -= 1;
        resendT.textContent = String(v);
        if (v <= 0) { clearInterval(timerId); resendBtn.disabled = false; resendT.textContent = '0'; }
      }, 1000);
    }

    document.getElementById('signinForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = e.target.email.value.trim();
      if(!email) return;
      currentEmail = email;
      const res = await postForm({ action:'start_login', email });
      if(res && res.ok){
        showToast('Code sent to '+email);
        e.target.style.display='none';
        const cf = document.getElementById('codeForm');
        cf.style.display='grid'; cf.dataset.email = email;
        startResendTimer(30);
      } else { showToast('Could not send code. Check settings.'); }
    });
    resendBtn.addEventListener('click', async ()=>{
      if(!currentEmail) return;
      resendBtn.disabled = true;
      const res = await postForm({ action:'start_login', email: currentEmail });
      if(res && res.ok){ showToast('Code re-sent to '+currentEmail); startResendTimer(30); }
      else { showToast('Could not resend.'); resendBtn.disabled = false; }
    });

    document.getElementById('codeForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const code = e.target.code.value.trim();
      const email = e.target.dataset.email;
      const res = await postForm({ action:'verify_code', email, code });
      if(res && res.ok && res.token){
        localStorage.setItem(AUTH_TOKEN_KEY, res.token);
        localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile || { email }));
        showToast('Signed in!');
        renderAuthUI();
        closeSignin();
        setTimeout(openProfile, 350);
      } else { showToast('Invalid or expired code. Try again.'); }
    });

    // --- Profile save
    document.getElementById('profileForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const pid = document.getElementById('p_place_id').value;
      if(!pid) { showToast('Choose a valid address from suggestions.'); return; }
      const res = await saveProfile(data.role||'', data);
      if(res && res.ok){ showToast('Profile saved'); closeProfile(); renderAuthUI(); }
      else showToast('Could not save profile');
    });

    // --- Owner submit
    document.getElementById('ownerForm').addEventListener('submit', async (e)=>{
      const pid = document.getElementById('o_place_id').value;
      if(!pid) { e.preventDefault(); showToast('Please select an address from suggestions.'); return; }
      const d = document.getElementById('date_owner').value;
      if(!d || new Date(d) < new Date(new Date().toDateString())){ e.preventDefault(); showToast('Date can\\'t be in the past.'); return; }

      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const token = localStorage.getItem(AUTH_TOKEN_KEY); if(token) data._token = token;
      const res = await postForm({ kind:'owner', data });
      if(res && res.ok){
        if(res.profile) localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile));
        showToast('Submitted to Google Sheet.'); e.target.reset(); closeOwner();
      } else { showToast('Saved locally (try again later).'); e.target.reset(); closeOwner(); }
    });

    // --- Walker submit
    document.getElementById('walkerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const token = localStorage.getItem(AUTH_TOKEN_KEY); if(token) data._token = token;
      const res = await postForm({ kind:'walker', data });
      if(res && res.ok){
        if(res.profile) localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile));
        showToast('Submitted to Google Sheet.'); e.target.reset(); closeWalker();
      } else { showToast('Saved locally (try again later).'); e.target.reset(); closeWalker(); }
    });

    function addCard(){ alert('Card-on-file will be added via Stripe later. We do not store card numbers.'); }
    document.getElementById('yr').textContent = new Date().getFullYear();

    (async function init(){
      renderAuthUI();
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if(token) await getProfile();
      renderAuthUI();
      // date min on load (also set when opening owner modal)
      const el = document.getElementById('date_owner');
      if (el) { const tzToday = new Date().toISOString().slice(0,10); el.min = tzToday; }
    })();
  </script>

  <!-- Load Google Maps JS + Places (CH) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxiPfbUuLimnZa7MePEtAltu83ZDUugPs&libraries=places&region=CH&language=en&callback=initMaps"></script>
  <script src="site-patch.js"></script>
</body>
</html>
