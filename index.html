<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DogWalkr ‚Äî Switzerland beta</title>
  <meta name="description" content="Book trusted dog walkers in Switzerland. Owners and walkers can create accounts to save their details." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üêæ</text></svg>">
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxiPfbUuLimnZa7MePEtAltu83ZDUugPs&libraries=places&region=CH&language=en"></script>
  <style>
    :root{ --bg:#0b0f14; --card:#0f1722cc; --text:#e8f0ff; --text-dim:#b7c2d6; --brand:#7cc6ff; --shadow:0 10px 30px rgba(0,0,0,.35); --ring:0 0 0 2px rgba(124,198,255,.35); --radius:18px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font:16px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text);
         background:radial-gradient(1200px 600px at 10% 10%, #162030, transparent 50%), radial-gradient(800px 600px at 100% 0%, #1a2740, transparent 40%), var(--bg);}
    a{color:var(--brand); text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:1100px; margin:0 auto; padding:28px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:6px 12px; background:linear-gradient(180deg,rgba(255,255,255,.03),transparent); border-radius:var(--radius)}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px}
    .logo{width:36px; height:36px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg, #7cc6ff 0%, #b7ffcc 100%); box-shadow:var(--shadow); color:#001428; font-size:20px}
    nav{display:flex; gap:14px; align-items:center}
    .btn{appearance:none; border:0; background:linear-gradient(180deg, #122033, #0f1826); color:var(--text); padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:700; box-shadow:var(--shadow); transition: transform .05s ease, box-shadow .2s ease, filter .2s ease; font-size:14px;}
    .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)} .btn.primary{background:linear-gradient(180deg, #80d0ff, #66a8ff); color:#021326} .btn.ghost{background:transparent; border:1px solid #233145}
    .hero{display:grid; grid-template-columns: 1.2fr 1fr; gap:28px; margin:44px 0 28px} .card{background:var(--card); border:1px solid #213149; border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(8px)} .hero .card{padding:32px}
    .eyebrow{display:inline-flex; align-items:center; gap:10px; font-size:12px; color:var(--text-dim); background:#0b1320; border:1px solid #1e2b40; padding:6px 10px; border-radius:999px}
    h1{margin:12px 0 6px; font-size:44px; line-height:1.1; letter-spacing:-.02em} .lead{color:var(--text-dim); margin:8px 0 20px} .cta{display:flex; gap:12px; flex-wrap:wrap}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid #1f2c43; border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:18px} .section{margin:38px 0} .section h2{margin:0 0 12px; font-size:22px}
    .muted{color:var(--text-dim)} .list{display:grid; gap:8px; margin:8px 0 0; padding:0; list-style:none} .list li{display:flex; gap:10px; align-items:flex-start} .pill{display:inline-flex; align-items:center; gap:8px; border:1px solid #213149; background:#0d1522; padding:6px 10px; border-radius:999px; font-size:12px; color:#c2d2ec}
    footer{margin:42px 0 8px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; color:var(--text-dim)} footer .links{display:flex; gap:16px; align-items:center}
    dialog{width:min(560px, 92vw); border:1px solid #253552; background:#0c1320; border-radius:18px; color:#e9f2ff; box-shadow: var(--shadow)} dialog::backdrop{background:rgba(1,5,12,.6); backdrop-filter: blur(3px)}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #1d2a41} .modal-body{padding:16px}
    form{display:grid; gap:12px} label{font-size:13px; color:#c7d4ea} input,select,textarea{width:100%; padding:12px; border-radius:12px; background:#0a111c; color:#e9f2ff; border:1px solid #20304a; outline:none; transition: box-shadow .15s ease, border-color .15s ease}
    input:focus, select:focus, textarea:focus{box-shadow: var(--ring); border-color:#3a5a86} textarea{min-height:92px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px} .terms{display:flex; gap:10px; align-items:flex-start; font-size:13px; color:#c9d7ee}
    .toast{position:fixed; top:18px; right:18px; background:linear-gradient(180deg,#122033,#0f1826); border:1px solid #22324c; color:#e9f2ff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); display:none}
    .admin-drawer{position:fixed; top:0; right:-460px; width:420px; height:100%; background:#0a111c; border-left:1px solid #22324c; box-shadow:var(--shadow); transition:right .25s ease} .admin-drawer.open{right:0}
    .admin-drawer header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #1a2942} .admin-drawer .scroll{height:calc(100% - 120px); overflow:auto; padding:12px 16px}
    .empty{color:#94a8c7; font-size:14px; padding:12px 6px} .item{border:1px solid #20324b; border-radius:14px; padding:12px; margin:10px 0; background:#0d1522} .caps{letter-spacing:.12em; text-transform:uppercase; font-size:12px; color:#9cb5d9}
    .badge{display:inline-flex; gap:6px; padding:4px 8px; border-radius:999px; background:#0c1626; border:1px solid #1e2d46; font-size:12px; color:#a8c2e6}
    details#diag summary{cursor:pointer; user-select:none} #diag pre{background:#0d1522; border:1px solid #213149; padding:10px; border-radius:12px; overflow:auto}
    .chip{display:inline-flex; align-items:center; gap:8px; border:1px solid #213149; background:#0d1522; padding:6px 10px; border-radius:999px; font-size:12px; color:#c2d2ec}
    @media (max-width: 900px){ .hero{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div class="brand">
        <div class="logo">üêæ</div>
        <div>
          <div style="font-size:14px; color:var(--text-dim); line-height:1;">Introducing</div>
          <div style="font-size:18px;">DogWalkr ‚Äî Switzerland</div>
        </div>
      </div>
      <nav>
        <a href="#how">How it works</a>
        <a href="#trust">Trust & Safety</a>
        <a href="#faq">FAQ</a>
        <button class="btn ghost" onclick="openWalker()">Become a Walker</button>
        <button class="btn primary" onclick="openOwner()">Book a Walk</button>
        <button class="btn" id="signinBtn" onclick="openSignin()">Sign in</button>
        <div id="userChip" style="display:none" class="chip"></div>
      </nav>
    </header>

    <section class="hero">
      <div class="card">
        <span class="eyebrow">Simple ‚Ä¢ Safe ‚Ä¢ Accounts</span>
        <h1>Book trusted dog walkers <span style="color:var(--brand)">in minutes</span>.</h1>
        <p class="lead">Create an account once, and your info auto-fills every time ‚Äî for owners and walkers.</p>
        <div class="cta">
          <button class="btn primary" onclick="openOwner()">Book a Walk</button>
          <button class="btn" onclick="openWalker()">Become a Walker</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:16px; flex-wrap:wrap">
          <span class="pill">‚è±Ô∏è 30‚Äì90 min walks</span>
          <span class="pill">üìç Z√ºrich ‚Ä¢ Gen√®ve ‚Ä¢ Basel ‚Ä¢ Bern</span>
          <span class="pill">üí¨ Photo updates</span>
          <span class="pill">‚≠ê Two-way ratings</span>
        </div>
      </div>
      <div class="glass">
        <div class="section">
          <h2>Why DogWalkr?</h2>
        </div>
        <div class="grid">
          <div class="glass">
            <div class="caps">Owners</div>
            <div class="muted small">Pick date, time, duration. Add notes. Post the request.</div>
          </div>
          <div class="glass">
            <div class="caps">Walkers</div>
            <div class="muted small">Browse nearby jobs. Accept. Complete walk. Get paid.</div>
          </div>
          <div class="glass">
            <div class="caps">Platform</div>
            <div class="muted small">Small fee per walk. Trust tools. Later: payments & insurance.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="how">
      <h2>How it works</h2>
      <div class="grid">
        <div class="card" style="padding:18px">
          <div class="caps">1. Post your walk</div>
          <div class="muted small">Choose date/time & duration. Add dog details and notes.</div>
        </div>
        <div class="card" style="padding:18px">
          <div class="caps">2. Get matched</div>
          <div class="muted small">Walkers nearby see the request and accept it.</div>
        </div>
        <div class="card" style="padding:18px">
          <div class="caps">3. Walk & pay</div>
          <div class="muted small">Walker completes the walk. You pay (cash or transfer). Rate each other.</div>
        </div>
      </div>
    </section>

    <section class="section" id="trust">
      <h2>Trust & Safety</h2>
      <div class="grid">
        <div class="glass">
          <div class="caps">Verification</div>
          <div class="muted small">ID checks for walkers; optional background-check badge.</div>
        </div>
        <div class="glass">
          <div class="caps">Transparency</div>
          <div class="muted small">Photo updates and GPS route (via messaging app in MVP).</div>
        </div>
        <div class="glass">
          <div class="caps">Fair Policies</div>
          <div class="muted small">Clear Terms. Independent contractor status for walkers.</div>
        </div>
      </div>
      <p class="muted small" style="margin-top:10px">Note: Features like insurance and built-in payments can be added later.</p>
    </section>

    <section class="section" id="faq">
      <h2>FAQ</h2>
      <div class="glass">
        <details>
          <summary><b>Do I need an account?</b></summary>
          <p class="muted small">No, but if you sign in, we‚Äôll auto-fill your forms next time.</p>
        </details>
        <details>
          <summary><b>Is this Switzerland-only?</b></summary>
          <p class="muted small">Yes, address suggestions are restricted to Switzerland.</p>
        </details>
      </div>
    </section>

    <footer>
      <div class="links">
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
        <a href="#" onclick="toggleAdmin(); return false;">Submissions</a>
      </div>
      <div class="small">¬© <span id="yr"></span> DogWalkr. Made with ‚ù§Ô∏è</div>
    </footer>

    <details id="diag" class="section glass" style="margin-top:18px">
      <summary>Diagnostics & Tests (click to view)</summary>
      <div style="display:flex;gap:8px;margin:8px 0 6px">
        <button class="btn small" onclick="runConnTest()">Run connection test</button>
        <button class="btn small" onclick="copyLastPayload()">Copy last payload</button>
      </div>
      <div id="diagOut" class="small muted"></div>
      <div id="diagNet" class="small muted"></div>
      <pre id="diagLog"></pre>
    </details>

  </div>

  <!-- Sign-in Modal -->
  <dialog id="signinModal">
    <div class="modal-head">
      <strong>Sign in / Create account</strong>
      <button class="btn ghost small" onclick="closeSignin()">Close</button>
    </div>
    <div class="modal-body">
      <form id="signinForm">
        <label>Email (we‚Äôll send a 6-digit code)</label>
        <input required type="email" name="email" placeholder="you@email.com">
        <button class="btn primary" type="submit">Send code</button>
      </form>
      <form id="codeForm" style="display:none">
        <label>Enter 6-digit code</label>
        <input required inputmode="numeric" pattern="\d{6}" minlength="6" maxlength="6" name="code" placeholder="123456">
        <button class="btn primary" type="submit">Verify</button>
      </form>
    </div>
  </dialog>

  <!-- Owner Modal -->
  <dialog id="ownerModal">
    <div class="modal-head">
      <strong>Book a Walk</strong>
      <button class="btn ghost small" onclick="closeOwner()">Close</button>
    </div>
    <div class="modal-body">
      <form id="ownerForm">
        <div class="row">
          <div>
            <label>Full name</label>
            <input required name="name" placeholder="Jane Doe">
          </div>
          <div>
            <label>Email</label>
            <input required type="email" name="email" placeholder="jane@email.com">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Phone</label>
            <input required name="phone" placeholder="+41 79 123 45 67">
          </div>
          <div>
            <label>Neighborhood / Address</label>
            <input required name="address" id="address" placeholder="Bahnhofstrasse 1, Z√ºrich">
            <input type="hidden" name="place_id" id="place_id">
            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lng" id="lng">
            <input type="hidden" name="formatted_address" id="formatted_address">
            <input type="hidden" name="postal_code" id="postal_code">
            <input type="hidden" name="locality" id="locality">
            <input type="hidden" name="canton" id="canton">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Dog name</label>
            <input required name="dog_name" placeholder="Biscuit">
          </div>
          <div>
            <label>Dog size</label>
            <select name="dog_size" required>
              <option value="">Choose‚Ä¶</option>
              <option>Small</option><option>Medium</option><option>Large</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Temperament</label>
            <select name="temperament" required>
              <option value="">Choose‚Ä¶</option>
              <option>Calm</option><option>Energetic</option><option>Shy</option><option>Reactive</option>
            </select>
          </div>
          <div>
            <label>Special notes</label>
            <input name="notes" placeholder="Leash reactive, avoid other dogs‚Ä¶">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Date</label>
            <input required type="date" name="date">
          </div>
          <div>
            <label>Time</label>
            <input required type="time" name="time">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Duration</label>
            <select name="duration" required>
              <option value="">Choose‚Ä¶</option>
              <option>30 min</option><option>45 min</option><option>60 min</option><option>90 min</option>
            </select>
          </div>
          <div>
            <label>Preferred pay method</label>
            <select name="pay_method">
              <option>Cash</option><option>Transfer</option>
            </select>
          </div>
        </div>
        <label>Extra details</label>
        <textarea name="extra" placeholder="Any building entry notes, route preference, etc."></textarea>
        <div class="terms">
          <input required type="checkbox" id="ownerAgree">
          <label for="ownerAgree">I agree to the Terms and acknowledge the liability waiver.</label>
        </div>
        <button class="btn primary" type="submit">Submit request</button>
      </form>
    </div>
  </dialog>

  <!-- Walker Modal -->
  <dialog id="walkerModal">
    <div class="modal-head">
      <strong>Become a Walker</strong>
      <button class="btn ghost small" onclick="closeWalker()">Close</button>
    </div>
    <div class="modal-body">
      <form id="walkerForm">
        <div class="row">
          <div>
            <label>Full name</label>
            <input required name="name" placeholder="John Smith">
          </div>
          <div>
            <label>Email</label>
            <input required type="email" name="email" placeholder="john@email.com">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Phone</label>
            <input required name="phone" placeholder="+41 78 123 45 67">
          </div>
          <div>
            <label>City</label>
            <input required name="city" placeholder="Z√ºrich / Gen√®ve / Basel / Bern">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Experience level</label>
            <select name="experience" required>
              <option value="">Choose‚Ä¶</option>
              <option>Beginner</option><option>Intermediate</option><option>Pro</option>
            </select>
          </div>
          <div>
            <label>Background check badge</label>
            <select name="bg_check">
              <option>Not yet</option><option>Yes, verified</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Availability</label>
            <input name="availability" placeholder="Weekdays 17:00‚Äì20:00; Weekends">
          </div>
          <div>
            <label>Rate expectation (per hour)</label>
            <input name="rate" type="number" min="1" step="1" placeholder="25">
          </div>
        </div>
        <label>About you</label>
        <textarea name="bio" placeholder="Short intro: experience with breeds, training, etc."></textarea>
        <div class="terms">
          <input required type="checkbox" id="walkerAgree">
          <label for="walkerAgree">I accept the Independent Contractor Terms and agree to follow safety guidelines.</label>
        </div>
        <button class="btn primary" type="submit">Apply</button>
      </form>
    </div>
  </dialog>

  <div id="toast" class="toast">Saved. We‚Äôll get back to you soon.</div>

  <aside id="drawer" class="admin-drawer">
    <header>
      <strong>Submissions</strong>
      <div style="display:flex; gap:8px">
        <button class="btn small" onclick="exportJSON('owner')">Export owners</button>
        <button class="btn small" onclick="exportJSON('walker')">Export walkers</button>
        <button class="btn small" onclick="exportCSV('owner')">CSV owners</button>
        <button class="btn small" onclick="exportCSV('walker')">CSV walkers</button>
        <button class="btn small danger" onclick="clearAll()">Clear</button>
        <button class="btn ghost small" onclick="toggleAdmin()">Close</button>
      </div>
    </header>
    <div class="scroll" id="items"></div>
  </aside>

  <script>
    const FORM_ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbzH2gCzqnqzUFa0ZYknaQndwYvT7MijTCL5KkdukcZLMm017eD9zawp40FnrarS1BwIMg/exec";
    const DEMO_STORAGE_KEY = "dogwalkr_submissions_v1";
    const AUTH_TOKEN_KEY = "dogwalkr_auth_token";
    const PROFILE_KEY = "dogwalkr_profile";

    const ownerModal = document.getElementById('ownerModal');
    const walkerModal = document.getElementById('walkerModal');
    const signinModal = document.getElementById('signinModal');
    const toast = document.getElementById('toast');
    const signinBtn = document.getElementById('signinBtn');
    const userChip = document.getElementById('userChip');

    function openOwner(){ ownerModal.showModal(); prefillFormFromProfile('owner'); }
    function closeOwner(){ ownerModal.close(); }
    function openWalker(){ walkerModal.showModal(); prefillFormFromProfile('walker'); }
    function closeWalker(){ walkerModal.close(); }
    function openSignin(){ signinModal.showModal(); }
    function closeSignin(){ signinModal.close(); }

    function showToast(msg="Saved. We‚Äôll get back to you soon."){
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 2200);
    }

    function getStore(){ try{ return JSON.parse(localStorage.getItem(DEMO_STORAGE_KEY) || '{}'); } catch(e){ return {}; } }
    function setStore(obj){ localStorage.setItem(DEMO_STORAGE_KEY, JSON.stringify(obj)); }
    function pushSubmission(kind, data){
      const store = getStore();
      const list = store[kind] || [];
      list.unshift({ts: new Date().toISOString(), kind, data});
      store[kind] = list; setStore(store);
    }

    const drawer = document.getElementById('drawer');
    function toggleAdmin(){ drawer.classList.toggle('open'); renderItems(); }
    function renderItems(){
      const {owner = [], walker = []} = getStore();
      const mount = document.getElementById('items');
      const mk = (it) => {
        const pretty = JSON.stringify(it, null, 2);
        return `<div class="item">
          <div class="badge">${it.kind.toUpperCase()} ‚Ä¢ <span class="muted">${new Date(it.ts).toLocaleString()}</span></div>
          <pre style="white-space:pre-wrap; margin:8px 0; font-size:12px; color:#cbe0ff">${pretty}</pre>
        </div>`;
      };
      const html = (owner.length ? owner.map(mk).join('') : '<div class="empty">No owner requests yet.</div>')
                + (walker.length ? walker.map(mk).join('') : '<div class="empty">No walker applications yet.</div>');
      mount.innerHTML = html;
    }
    function exportJSON(kind){
      const store = getStore();
      const data = store[kind] || [];
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${kind}_submissions.json`;
      a.click(); URL.revokeObjectURL(a.href);
    }
    function exportCSV(kind){
      const store = getStore();
      const data = store[kind] || [];
      if(!data.length){ alert('No data to export.'); return; }
      const keySet = new Set();
      data.forEach(it => Object.keys(it.data || {}).forEach(k => keySet.add(k)));
      const keys = Array.from(keySet);
      const headers = ['ts','kind',...keys];
      const escape = v => { const s = String(v == null ? '' : v).replaceAll('"','""'); return `"${s}"`; };
      const rows = data.map(it => [it.ts, it.kind, ...keys.map(k => (it.data||{})[k] ?? '')]);
      const csv = [headers.map(escape).join(','), ...rows.map(r => r.map(escape).join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${kind}_submissions.csv`;
      a.click(); URL.revokeObjectURL(a.href);
    }
    function clearAll(){ if(!confirm('Clear all stored demo submissions?')) return; setStore({}); renderItems(); }

    async function postPayload(obj){
      const formBody = new URLSearchParams();
      formBody.append('payload', JSON.stringify(obj));
      const r = await fetch(FORM_ENDPOINT_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: formBody });
      const txt = await r.text().catch(()=>'');
      try { return JSON.parse(txt); } catch { return { ok: r.ok, raw: txt }; }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const waitForPlaces = (cb) => {
        if (window.google && google.maps && google.maps.places) cb();
        else setTimeout(() => waitForPlaces(cb), 100);
      };
      waitForPlaces(initPlaces);
    });
    function initPlaces(){
      const input = document.querySelector('input[name="address"]');
      if (!input) return;
      const ac = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: ['ch'] },
        fields: ['place_id','geometry','formatted_address','address_components','name'],
        types: ['address']
      });
      ac.addListener('place_changed', () => {
        const place = ac.getPlace();
        if (!place || !place.place_id || !place.geometry) {
          input.setCustomValidity('Please pick a valid address from the suggestions.');
          return;
        }
        input.setCustomValidity('');
        const comps = {};
        (place.address_components || []).forEach(c => c.types.forEach(t => comps[t] = c.long_name));
        document.getElementById('place_id').value = place.place_id;
        document.getElementById('lat').value = place.geometry.location.lat();
        document.getElementById('lng').value = place.geometry.location.lng();
        document.getElementById('formatted_address').value = place.formatted_address || place.name || input.value;
        document.getElementById('postal_code').value = comps.postal_code || '';
        document.getElementById('locality').value = comps.locality || comps.postal_town || comps.sublocality || '';
        document.getElementById('canton').value = comps.administrative_area_level_1 || '';
      });
      input.addEventListener('input', () => {
        ['place_id','lat','lng','formatted_address','postal_code','locality','canton']
          .forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
        input.setCustomValidity('');
      });
    }

    document.getElementById('signinForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = e.target.email.value.trim();
      if(!email) return;
      const res = await postPayload({ action:'start_login', email });
      if(res && res.ok){
        showToast('Code sent to '+email);
        e.target.style.display='none';
        document.getElementById('codeForm').style.display='grid';
        document.getElementById('codeForm').dataset.email = email;
      } else {
        showToast('Could not send code. Check your email format or try again.');
      }
    });
    document.getElementById('codeForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const code = e.target.code.value.trim();
      const email = e.target.dataset.email;
      const res = await postPayload({ action:'verify_code', email, code });
      if(res && res.ok && res.token){
        localStorage.setItem(AUTH_TOKEN_KEY, res.token);
        localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile || {}));
        showToast('Signed in!');
        renderAuthUI();
        closeSignin();
      } else {
        showToast('Invalid or expired code. Try again.');
      }
    });

    function signOut(){
      localStorage.removeItem(AUTH_TOKEN_KEY);
      localStorage.removeItem(PROFILE_KEY);
      renderAuthUI();
      showToast('Signed out');
    }

    async function getProfile(){
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if(!token) return null;
      const res = await postPayload({ action:'get_profile', token });
      if(res && res.ok){
        localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile || {}));
        return res.profile || null;
      }
      return null;
    }
    async function saveProfile(role, data){
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if(!token) return {ok:false};
      const res = await postPayload({ action:'save_profile', token, role, profile: data });
      if(res && res.ok){ localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile || {})); }
      return res;
    }

    function prefillFormFromProfile(kind){
      try{
        const prof = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
        const form = (kind==='owner') ? document.getElementById('ownerForm') : document.getElementById('walkerForm');
        if(!form) return;
        const map = (k) => form.querySelector(`[name="${k}"]`);
        if (map('name') && prof.name) map('name').value = prof.name;
        if (map('email') && prof.email) map('email').value = prof.email;
        if (map('phone') && prof.phone) map('phone').value = prof.phone;
        if(kind==='owner'){
          if (map('address') && prof.formatted_address) map('address').value = prof.formatted_address;
          ['place_id','lat','lng','formatted_address','postal_code','locality','canton'].forEach(id => {
            if (document.getElementById(id) && prof[id]) document.getElementById(id).value = prof[id];
          });
        }
        if(kind==='walker'){
          if (map('city') && prof.city) map('city').value = prof.city;
          if (map('experience') && prof.experience) map('experience').value = prof.experience;
          if (map('bg_check') && prof.bg_check) map('bg_check').value = prof.bg_check;
          if (map('availability') && prof.availability) map('availability').value = prof.availability;
          if (map('rate') && prof.rate) map('rate').value = prof.rate;
          if (map('bio') && prof.bio) map('bio').value = prof.bio;
        }
      }catch(_){}
    }

    function renderAuthUI(){
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      const prof = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}');
      if(token){
        signinBtn.style.display='none';
        userChip.style.display='inline-flex';
        userChip.innerHTML = `${prof.name ? prof.name : (prof.email||'Account')} <button class="btn ghost small" style="margin-left:8px" onclick="signOut()">Sign out</button>`;
      } else {
        signinBtn.style.display='inline-block';
        userChip.style.display='none';
      }
    }

    async function handleSubmit(kind, form){
      const data = Object.fromEntries(new FormData(form).entries());
      if (kind === 'owner') {
        const pid = document.getElementById('place_id').value;
        if (!pid) {
          showToast('Please choose a valid address from the suggestions.');
          const addr = form.querySelector('input[name="address"]');
          if (addr) addr.focus();
          return;
        }
      }
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if(token) data._token = token;
      const payload = {kind, data};
      window._lastPayload = payload;
      try{
        const res = await postPayload(payload);
        if(res && res.ok){
          if(res.profile) localStorage.setItem(PROFILE_KEY, JSON.stringify(res.profile));
          showToast('Submitted to Google Sheet.');
          form.reset();
          if(kind==='owner') closeOwner(); else closeWalker();
        } else {
          pushSubmission(kind, data);
          showToast('Saved locally (offline).');
          form.reset();
          if(kind==='owner') closeOwner(); else closeWalker();
        }
      } catch(_){
        pushSubmission(kind, data); showToast('Saved locally (offline).'); form.reset(); if(kind==='owner') closeOwner(); else closeWalker();
      }
    }

    document.getElementById('ownerForm').addEventListener('submit', (e)=>{ e.preventDefault(); handleSubmit('owner', e.target); });
    document.getElementById('walkerForm').addEventListener('submit', (e)=>{ e.preventDefault(); handleSubmit('walker', e.target); });

    document.getElementById('yr').textContent = new Date().getFullYear();

    function runConnTest(){
      const test = { kind:'healthcheck', data:{ ts: new Date().toISOString(), note:'Hello from DogWalkr diagnostics (CH + Accounts)' } };
      window._lastPayload = test;
      postPayload(test).then(()=>{
        const diagNet = document.getElementById('diagNet'); if (diagNet) diagNet.textContent = 'Healthcheck posted.';
      });
    }
    function copyLastPayload(){
      const txt = JSON.stringify(window._lastPayload || {}, null, 2);
      navigator.clipboard.writeText(txt).then(()=> showToast('Payload copied'));
    }

    (async function initApp(){
      renderAuthUI();
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if(token){ await getProfile(); renderAuthUI(); }
      try{
        const out = [];
        const assert = (name, cond) => out.push(`${cond ? '‚úÖ' : '‚ùå'} ${name}`);
        assert('openOwner() is defined', typeof openOwner === 'function');
        assert('openWalker() is defined', typeof openWalker === 'function');
        const diagOut = document.getElementById('diagOut'); if (diagOut) diagOut.textContent = out.join('\n');
      }catch(_){}
    })();
  </script>

<!-- PATCH-2: Maps bootstrap + Autocomplete fallback + endpoint fallback -->
<script>
(function() {
  var API_KEY = 'AIzaSyDxiPfbUuLimnZa7MePEtAltu83ZDUugPs';
  var EXEC_URL = 'https://script.google.com/macros/s/AKfycbx3UWliJD5I0bLPuGX_fpoTjDm7SvOF3uLf-zVjgLpyS1u6KxhfK0BPoqm5DJMuLR3INQ/exec';

  // 1) Ensure FORM_ENDPOINT_URL exists
  if (!window.FORM_ENDPOINT_URL) {
    window.FORM_ENDPOINT_URL = EXEC_URL;
    console.log('[Patch-2] FORM_ENDPOINT_URL fallback set to', EXEC_URL);
  }

  // 2) Ensure postForm exists
  if (typeof window.postForm !== 'function') {
    window.postForm = async function(obj) {
      try {
        const r = await fetch(window.FORM_ENDPOINT_URL, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ payload: JSON.stringify(obj) })
        });
        const t = await r.text().catch(()=>'');
        try { return JSON.parse(t); } catch (_){
          return r.ok ? {ok:true, opaque:true} : {ok:false, error:'HTTP '+r.status};
        }
      } catch (e) {
        console.warn('[Patch-2] postForm failed', e);
        return {ok:false, error:String(e)};
      }
    };
    console.log('[Patch-2] postForm fallback installed');
  }

  // 3) Attach Autocomplete (widget) to inputs and fill hidden fields
  function attachAutocompleteTo(idInput, hiddenMap) {
    var input = document.getElementById(idInput);
    if (!input) return;
    if (!window.google || !google.maps || !google.maps.places) return;

    var ac = new google.maps.places.Autocomplete(input, {
      componentRestrictions: { country: ['ch'] },
      fields: ['place_id','formatted_address','geometry','address_components','name']
    });
    ac.addListener('place_changed', function(){
      var place = ac.getPlace();
      if (!place || !place.geometry) return;
      var comps = {};
      (place.address_components||[]).forEach(function(c){ (c.types||[]).forEach(function(t){ comps[t]=c.long_name; }); });
      function set(id, val){ var el=document.getElementById(id); if(el) el.value = val || ''; }
      set(hiddenMap.place_id, place.place_id || '');
      set(hiddenMap.lat, place.geometry.location.lat());
      set(hiddenMap.lng, place.geometry.location.lng());
      set(hiddenMap.formatted, place.formatted_address || place.name || input.value);
      set(hiddenMap.postal, comps.postal_code || '');
      set(hiddenMap.locality, comps.locality || comps.postal_town || comps.sublocality || '');
      set(hiddenMap.canton, comps.administrative_area_level_1 || '');
    });
    console.log('[Patch-2] Autocomplete attached to #' + idInput);
  }

  // 4) Fallback init that attaches the widgets
  function initMapsPatch() {
    attachAutocompleteTo('address_owner', {
      place_id:'o_place_id', lat:'o_lat', lng:'o_lng',
      formatted:'o_formatted_address', postal:'o_postal_code',
      locality:'o_locality', canton:'o_canton'
    });
    attachAutocompleteTo('address_profile', {
      place_id:'p_place_id', lat:'p_lat', lng:'p_lng',
      formatted:'p_formatted_address', postal:'p_postal_code',
      locality:'p_locality', canton:'p_canton'
    });
  }

  // 5) Ensure a global callback exists for the Google script
  if (typeof window.initMaps !== 'function') {
    window.initMaps = initMapsPatch;
    console.log('[Patch-2] window.initMaps installed');
  }

  // 6) Load Maps JS if not present, else run now
  function loadMaps() {
    if (window.google && google.maps && google.maps.places) {
      try { initMapsPatch(); } catch(e) { console.warn(e); }
      return;
    }
    var s = document.createElement('script');
    s.src = 'https://maps.googleapis.com/maps/api/js?key=' + encodeURIComponent(API_KEY) + '&libraries=places&region=CH&language=en&callback=initMaps';
    s.async = true; s.defer = true;
    s.onerror = function(){ console.error('[Patch-2] Maps failed to load'); alert('Google Maps failed to load. Check API key & referrer restrictions.'); };
    document.head.appendChild(s);
    console.log('[Patch-2] Maps script injected');
  }
  loadMaps();

  // 7) Safety-net: if your sign-in form has no handler, wire a basic one
  document.addEventListener('DOMContentLoaded', function() {
    var sf = document.getElementById('signinForm');
    if (sf && !sf.dataset.patched) {
      sf.addEventListener('submit', async function(e){
        // only run if no other handler has set a data flag
        if (sf.dataset.nativeHandler === '1') return;
        e.preventDefault();
        var email = (sf.email && sf.email.value || '').trim();
        if (!email) return alert('Enter your email');
        var res = await window.postForm({ action:'start_login', email: email });
        if (res && res.ok) alert('Verification code sent to ' + email + '. Check Spam/Promotions too.');
        else alert('Could not send code. Check your Apps Script URL in the page.');
      }, false);
      sf.dataset.patched = '1';
      console.log('[Patch-2] signinForm fallback handler attached');
    }
  });
})();
</script>
</body>
</html>
