<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google Places — Verifier v3 (CH)</title>
  <style>
    :root{--bg:#0b0f14;--card:#0f1722cc;--text:#e8f0ff;--muted:#b7c2d6;--brand:#7cc6ff;--border:#253552;--shadow:0 12px 30px rgba(0,0,0,.35);--radius:16px}
    *{box-sizing:border-box} body{margin:0;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px} .muted{color:var(--muted)} .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:#c2d2ec;font-size:12px;margin-right:6px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-top:14px}
    .status{padding:8px 12px;border-radius:10px;display:inline-block;background:rgba(255,255,255,.06);border:1px solid var(--border);margin-right:8px;margin-bottom:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{position:relative} label{display:block;margin:12px 0 6px;color:#c7d4ea}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #20304a;background:#0a111c;color:#e9f2ff;outline:none}
    input:focus{box-shadow:0 0 0 2px rgba(124,198,255,.35);border-color:#3a5a86}
    pre{background:#0c1320;border:1px solid var(--border);padding:12px;border-radius:12px;overflow:auto;max-height:320px}
    .suggest-list{position:absolute;left:0;right:0;top:100%;margin-top:6px;z-index:99999;background:#0c1320;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);max-height:260px;overflow:auto;display:none}
    .suggest-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.06)}
    .suggest-item:last-child{border-bottom:0} .suggest-item:hover,.suggest-item.active{background:rgba(255,255,255,.08)}
    .btn{appearance:none;border:1px solid var(--border);background:#0c1320;color:#e9f2ff;padding:8px 12px;border-radius:10px;cursor:pointer;margin-right:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Google Places — Verifier v3</h1>
    <p class="muted">Custom dropdown (Switzerland). Triggers on <b>input</b>, <b>keyup</b>, and <b>change</b>. Also has manual test buttons.</p>

    <div class="card">
      <div id="badnews" style="display:none; padding:10px 12px; border:1px solid #5a1f1f; background:#2b1111; border-radius:12px; margin-bottom:10px">
        <b>Maps script failed to load.</b> Check Console for the exact Google error.
      </div>
      <div>
        <span class="status" id="sdk">SDK: loading…</span>
        <span class="status" id="pred">Predictions: —</span>
        <span class="status" id="det">Details: —</span>
        <span class="status">Origin: <code id="origin"></code></span>
        <span class="status">Add to key: <code id="pattern1"></code></span>
        <span class="status"><code id="pattern2"></code></span>
      </div>

      <div class="field" style="margin-top:14px">
        <label for="addr">Address (CH)</label>
        <input id="addr" placeholder="Bahnhofstrasse 1, Zürich" autocomplete="off">
        <div id="dd" class="suggest-list"></div>
        <div style="margin-top:8px">
          <button class="btn" id="btnTest">Test predictions (use current input)</button>
          <button class="btn" id="btnLaus">Try “Lausanne, Switzerland”</button>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <div>
          <label>Hidden fields (what your form would submit)</label>
          <pre id="hiddenOut">{}</pre>
        </div>
        <div>
          <label>Selected place (debug)</label>
          <pre id="placeOut">{}</pre>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <b>Load log</b>
        <pre id="log"></pre>
      </div>
    </div>
  </div>

  <!-- Hidden fields -->
  <input type="hidden" id="h_place_id">
  <input type="hidden" id="h_lat">
  <input type="hidden" id="h_lng">
  <input type="hidden" id="h_formatted">
  <input type="hidden" id="h_postal">
  <input type="hidden" id="h_locality">
  <input type="hidden" id="h_canton">

  <script>
    const LOG = document.getElementById('log');
    function log(msg){ LOG.textContent += msg + "\n"; console.log(msg); }

    const originEl = document.getElementById('origin');
    const patt1 = document.getElementById('pattern1');
    const patt2 = document.getElementById('pattern2');
    originEl.textContent = location.origin;
    patt1.textContent = location.origin + '/*';
    patt2.textContent = location.origin + location.pathname.replace(/\/[^\/]+$/, '') + '/*';

    // Programmatic loader
    const sdk = document.getElementById('sdk');
    const predS = document.getElementById('pred');
    const detS  = document.getElementById('det');
    const bad   = document.getElementById('badnews');
    let mapsLoaded = false, loadTimer = null, lastScript = null;

    function insertScript(){
      if(lastScript) lastScript.remove();
      const s = document.createElement('script');
      s.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyDxiPfbUuLimnZa7MePEtAltu83ZDUugPs&libraries=places&region=CH&language=en&callback=__mapsReady&_=" + Date.now();
      s.async = true; s.defer = true;
      s.onerror = () => { log("Script onerror fired"); sdk.textContent = "SDK: failed to load"; bad.style.display='block'; };
      document.body.appendChild(s);
      lastScript = s;
      sdk.textContent = "SDK: loading…"; bad.style.display='none';
      log("Inserted Google script");
      clearTimeout(loadTimer);
      loadTimer = setTimeout(()=>{ if(!mapsLoaded){ log("Timeout waiting for Maps"); sdk.textContent = "SDK: timeout (not loaded)"; bad.style.display='block'; }}, 10000);
    }

    window.__mapsReady = function(){
      mapsLoaded = true; sdk.textContent = "SDK: loaded"; log("Maps callback fired"); initMaps();
    };

    function initMaps(){
      log("initMaps() start");
      const cfg = {
        inputId: 'addr', listId: 'dd',
        hidden: { place_id:'h_place_id', lat:'h_lat', lng:'h_lng', formatted:'h_formatted', postal:'h_postal', locality:'h_locality', canton:'h_canton' }
      };
      const input = document.getElementById(cfg.inputId);
      const list  = document.getElementById(cfg.listId);
      const acSrv = new google.maps.places.AutocompleteService();
      const mapDiv = document.createElement('div');
      const placesSrv = new google.maps.places.PlacesService(mapDiv);

      let timer = null, activeIndex = -1;
      function hideList(){ list.style.display='none'; list.innerHTML=''; activeIndex=-1; }
      function render(preds){
        list.innerHTML = preds.slice(0,8).map((p,i)=>{
          const main = p.structured_formatting && p.structured_formatting.main_text ? p.structured_formatting.main_text : p.description;
          const sec = p.structured_formatting && p.structured_formatting.secondary_text ? ' — <span style="color:#9fb3d6">'+p.structured_formatting.secondary_text+'</span>' : '';
          return '<div class="suggest-item'+(i===activeIndex?' active':'')+'" data-pid="'+p.place_id.replace(/"/g,'&quot;')+'">'+main+sec+'</div>';
        }).join('');
        list.style.display = preds.length ? 'block' : 'none';
      }
      function setActive(i){
        const items = [...list.querySelectorAll('.suggest-item')];
        if(!items.length) return;
        activeIndex = (i + items.length) % items.length;
        items.forEach((el,idx)=> el.classList.toggle('active', idx===activeIndex));
        items[activeIndex].scrollIntoView({block:'nearest'});
      }
      function selectActive(){
        const it = list.querySelector('.suggest-item.active') || list.querySelector('.suggest-item');
        if(it) it.click();
      }

      function runPredictions(query){
        log("runPredictions: " + query);
        predS.textContent = "Predictions: running…";
        acSrv.getPlacePredictions({
          input: query, componentRestrictions: { country: ['ch'] }, types: ['address']
        }, (preds, status)=>{
          predS.textContent = "Predictions: " + status + " (" + (preds?preds.length:0) + ")";
          log("Predictions status: " + status + " len=" + (preds?preds.length:0));
          if(status !== google.maps.places.PlacesServiceStatus.OK || !preds || !preds.length){ hideList(); return; }
          activeIndex = -1; render(preds);
          list.querySelectorAll('.suggest-item').forEach(el=>el.addEventListener('click',()=>{
            const pid = el.getAttribute('data-pid');
            log("Click prediction pid=" + pid);
            placesSrv.getDetails({ placeId: pid, fields: ['place_id','formatted_address','geometry','address_components','name'] }, (place, s)=>{
              detS.textContent = "Details: " + s;
              log("Details status: " + s);
              if(s !== google.maps.places.PlacesServiceStatus.OK || !place || !place.geometry){ hideList(); return; }
              input.value = place.formatted_address || place.name || input.value;
              const comps = {}; (place.address_components||[]).forEach(c=>c.types.forEach(t=>comps[t]=c.long_name));
              document.getElementById(cfg.hidden.place_id).value = place.place_id || '';
              document.getElementById(cfg.hidden.lat).value = place.geometry.location.lat();
              document.getElementById(cfg.hidden.lng).value = place.geometry.location.lng();
              document.getElementById(cfg.hidden.formatted).value = place.formatted_address || place.name || input.value;
              document.getElementById(cfg.hidden.postal).value = comps.postal_code || '';
              document.getElementById(cfg.hidden.locality).value = comps.locality || comps.postal_town || comps.sublocality || '';
              document.getElementById(cfg.hidden.canton).value = comps.administrative_area_level_1 || '';
              document.getElementById('hiddenOut').textContent = JSON.stringify({
                place_id: place.place_id, lat: place.geometry.location.lat(), lng: place.geometry.location.lng(),
                formatted_address: place.formatted_address || place.name, postal_code: comps.postal_code || '',
                locality: comps.locality || comps.postal_town || comps.sublocality || '', canton: comps.administrative_area_level_1 || ''
              }, null, 2);
              document.getElementById('placeOut').textContent = JSON.stringify(place, null, 2);
              hideList();
            });
          }));
        });
      }

      function handleInput(){
        const q = input.value.trim();
        if(q.length >= 1){
          clearTimeout(timer);
          timer = setTimeout(()=> runPredictions(q), 100);
        } else {
          predS.textContent = "Predictions: (type…)"; hideList();
        }
      }

      // multiple triggers to be safe
      input.addEventListener('input', handleInput);
      input.addEventListener('keyup', handleInput);
      input.addEventListener('change', handleInput);

      input.addEventListener('keydown',(e)=>{
        const open = list.style.display==='block';
        if(!open) return;
        if(e.key==='ArrowDown'){ e.preventDefault(); setActive(activeIndex+1); }
        if(e.key==='ArrowUp'){ e.preventDefault(); setActive(activeIndex-1); }
        if(e.key==='Enter'){ e.preventDefault(); selectActive(); }
        if(e.key==='Escape'){ hideList(); }
      });

      document.getElementById('btnTest').addEventListener('click', ()=> runPredictions(input.value.trim()));
      document.getElementById('btnLaus').addEventListener('click', ()=>{ input.value = 'Lausanne, Switzerland'; runPredictions('Lausanne, Switzerland'); });
    }

    insertScript();
  </script>
</body>
</html>
