<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google Places — Verify (Switzerland)</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#0f1722cc; --text:#e8f0ff; --muted:#b7c2d6; --brand:#7cc6ff;
      --border:#253552; --shadow:0 12px 30px rgba(0,0,0,.35); --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:900px; margin:0 auto; padding:24px}
    h1{margin:0 0 8px} .muted{color:var(--muted)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .field{position:relative}
    label{display:block; margin:12px 0 6px; color:#c7d4ea}
    input{width:100%; padding:12px; border-radius:12px; border:1px solid #20304a; background:#0a111c; color:#e9f2ff; outline:none}
    input:focus{box-shadow:0 0 0 2px rgba(124,198,255,.35); border-color:#3a5a86}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .help{font-size:13px; color:var(--muted)}
    .status{padding:8px 12px; border-radius:10px; display:inline-block; background:rgba(255,255,255,.06); border:1px solid var(--border)}
    .suggest-list{
      position:absolute; left:0; right:0; top:100%; margin-top:6px;
      z-index:99999; background:#0c1320; border:1px solid var(--border); border-radius:12px;
      box-shadow:var(--shadow); max-height:260px; overflow:auto; display:none
    }
    .suggest-item{padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.06)}
    .suggest-item:last-child{border-bottom:0}
    .suggest-item:hover, .suggest-item.active{background:rgba(255,255,255,.08)}
    pre{background:#0c1320; border:1px solid var(--border); padding:12px; border-radius:12px; overflow:auto}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:#c2d2ec; font-size:12px; margin-right:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Google Places — Verification Page</h1>
    <p class="muted">Switzerland-only address autocomplete with a custom dropdown (no 2-letter limit, works inside modals).<br>
    <span class="pill">Maps JS</span><span class="pill">Places AutocompleteService</span><span class="pill">Places Details</span></p>

    <div class="card">
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
        <div class="status" id="sdk">SDK: loading…</div>
        <div class="status" id="pred">Predictions: —</div>
        <div class="status" id="det">Details: —</div>
      </div>

      <div class="field" style="margin-top:14px">
        <label for="addr">Type an address (CH)</label>
        <input id="addr" placeholder="Bahnhofstrasse 1, Zürich" autocomplete="off">
        <div id="dd" class="suggest-list"></div>
        <div class="help">Type at least 3 characters. Use ▲/▼ and Enter, or click.</div>
      </div>

      <div class="row" style="margin-top:16px">
        <div>
          <label>Hidden fields (what your form would submit)</label>
          <pre id="hiddenOut">{}</pre>
        </div>
        <div>
          <label>Selected place (debug)</label>
          <pre id="placeOut">{}</pre>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <b>Common failure reasons</b>
      <ul class="help">
        <li><b>Referer not allowed</b>: add <code>https://&lt;username&gt;.github.io/*</code> (and your repo path) to your key’s website restrictions.</li>
        <li><b>API not enabled</b>: enable “Maps JavaScript API” and “Places API”.</li>
        <li><b>Billing</b>: must be enabled for the key’s project.</li>
        <li><b>Loaded too early</b>: always use <code>&callback=initMaps</code>.</li>
      </ul>
    </div>
  </div>

  <script>
    // --- Custom dropdown based on Places AutocompleteService + PlacesService ---
    function initCustomAutocomplete(cfg){
      const input = document.getElementById(cfg.inputId);
      const list  = document.getElementById(cfg.listId);
      const sdkStatus = document.getElementById('sdk');
      const predStatus = document.getElementById('pred');
      const detStatus  = document.getElementById('det');
      if(!input || !list) return;

      const acSrv = new google.maps.places.AutocompleteService();
      const mapDiv = document.createElement('div');
      const placesSrv = new google.maps.places.PlacesService(mapDiv);

      let timer = null;
      let activeIndex = -1;

      function hideList(){ list.style.display='none'; list.innerHTML=''; activeIndex = -1; }
      function renderPredictions(preds){
        list.innerHTML = preds.slice(0,8).map((p,i)=>{
          const main = p.structured_formatting && p.structured_formatting.main_text ? p.structured_formatting.main_text : p.description;
          const sec  = p.structured_formatting && p.structured_formatting.secondary_text ? ' — <span style="color:#9fb3d6">'+p.structured_formatting.secondary_text+'</span>' : '';
          return '<div class="suggest-item'+(i===activeIndex?' active':'')+'" data-pid="'+p.place_id.replace(/"/g,'&quot;')+'">'+main+sec+'</div>';
        }).join('');
        list.style.display = preds.length ? 'block' : 'none';
      }
      function setActive(i){
        const items = [...list.querySelectorAll('.suggest-item')];
        if(!items.length) return;
        activeIndex = (i + items.length) % items.length;
        items.forEach((el,idx)=> el.classList.toggle('active', idx===activeIndex));
        items[activeIndex].scrollIntoView({block:'nearest'});
      }
      function selectActive(){
        const item = list.querySelector('.suggest-item.active') || list.querySelector('.suggest-item');
        if(item) item.click();
      }

      input.addEventListener('input', ()=>{
        // clear hidden on typing
        Object.values(cfg.hidden).forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
        document.getElementById('hiddenOut').textContent = JSON.stringify({
          place_id:'', lat:'', lng:'', formatted_address:'', postal_code:'', locality:'', canton:''
        }, null, 2);

        const q = input.value.trim();
        if(q.length < 3){ hideList(); predStatus.textContent = 'Predictions: (min 3 chars)'; return; }

        clearTimeout(timer);
        timer = setTimeout(()=>{
          acSrv.getPlacePredictions({
            input: q, componentRestrictions: { country: ['ch'] }, types: ['address']
          }, (preds, status)=>{
            predStatus.textContent = 'Predictions: '+status;
            if(status !== google.maps.places.PlacesServiceStatus.OK || !preds || !preds.length){ hideList(); return; }
            activeIndex = -1;
            renderPredictions(preds);
            // attach click
            list.querySelectorAll('.suggest-item').forEach(el=>{
              el.addEventListener('click', ()=>{
                const pid = el.getAttribute('data-pid');
                placesSrv.getDetails({ placeId: pid, fields:['place_id','formatted_address','geometry','address_components','name'] }, (place, s)=>{
                  detStatus.textContent = 'Details: '+s;
                  if(s !== google.maps.places.PlacesServiceStatus.OK || !place || !place.geometry){ hideList(); return; }
                  input.value = place.formatted_address || place.name || input.value;
                  const comps = {}; (place.address_components||[]).forEach(c => c.types.forEach(t => comps[t]=c.long_name));
                  // fill hidden
                  document.getElementById(cfg.hidden.place_id).value = place.place_id || '';
                  document.getElementById(cfg.hidden.lat).value = place.geometry.location.lat();
                  document.getElementById(cfg.hidden.lng).value = place.geometry.location.lng();
                  document.getElementById(cfg.hidden.formatted).value = place.formatted_address || place.name || input.value;
                  document.getElementById(cfg.hidden.postal).value = comps.postal_code || '';
                  document.getElementById(cfg.hidden.locality).value = comps.locality || comps.postal_town || comps.sublocality || '';
                  document.getElementById(cfg.hidden.canton).value = comps.administrative_area_level_1 || '';
                  // show debug
                  document.getElementById('hiddenOut').textContent = JSON.stringify({
                    place_id: place.place_id,
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    formatted_address: place.formatted_address || place.name,
                    postal_code: comps.postal_code || '',
                    locality: comps.locality || comps.postal_town || comps.sublocality || '',
                    canton: comps.administrative_area_level_1 || ''
                  }, null, 2);
                  document.getElementById('placeOut').textContent = JSON.stringify(place, null, 2);
                  hideList();
                });
              });
            });
          });
        }, 150);
      });

      // keyboard navigation
      input.addEventListener('keydown', (e)=>{
        const items = list.querySelectorAll('.suggest-item');
        if(!items.length) return;
        if(e.key === 'ArrowDown'){ e.preventDefault(); setActive(activeIndex+1); }
        if(e.key === 'ArrowUp'){ e.preventDefault(); setActive(activeIndex-1); }
        if(e.key === 'Enter'){ if(list.style.display==='block'){ e.preventDefault(); selectActive(); } }
        if(e.key === 'Escape'){ hideList(); }
      });

      document.addEventListener('click', (e)=>{ if(!list.contains(e.target) && e.target !== input) hideList(); });

      // mark SDK as loaded for UI
      sdkStatus.textContent = 'SDK: loaded';
    }

    // callback from Google script
    function initMaps(){
      initCustomAutocomplete({
        inputId: 'addr',
        listId: 'dd',
        hidden: {
          place_id:'h_place_id', lat:'h_lat', lng:'h_lng',
          formatted:'h_formatted', postal:'h_postal', locality:'h_locality', canton:'h_canton'
        }
      });
    }
  </script>

  <!-- Hidden fields to show what would be submitted -->
  <input type="hidden" id="h_place_id">
  <input type="hidden" id="h_lat">
  <input type="hidden" id="h_lng">
  <input type="hidden" id="h_formatted">
  <input type="hidden" id="h_postal">
  <input type="hidden" id="h_locality">
  <input type="hidden" id="h_canton">

  <!-- Load Maps JavaScript + Places (CH) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxiPfbUuLimnZa7MePEtAltu83ZDUugPs&libraries=places&region=CH&language=en&callback=initMaps"></script>
</body>
</html>
